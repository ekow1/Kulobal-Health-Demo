name: Deploy to VPS

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Build application
      run: |
        npm run build
        npm run build:api

    - name: Test SSH Connection
      if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USERNAME }}
        key: ${{ secrets.VPS_SSH_KEY }}
        passphrase: ${{ secrets.VPS_SSH_PASSPHRASE }}
        port: ${{ secrets.VPS_PORT }}
        timeout: 30s
        command_timeout: 2m
        script: |
          echo "SSH connection test successful!"
          whoami
          pwd
          echo "Testing Docker availability..."
          docker --version

    - name: Deploy to VPS
      if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USERNAME }}
        key: ${{ secrets.VPS_SSH_KEY }}
        passphrase: ${{ secrets.VPS_SSH_PASSPHRASE }}
        port: ${{ secrets.VPS_PORT }}
        timeout: 60s
        command_timeout: 15m
        script: |
          echo "Starting deployment..."
          cd /opt/kulobal-health-demo
          echo "Current directory: $(pwd)"
          echo "Pulling latest changes..."
          git pull origin main
          echo "Stopping containers..."
          docker-compose down
          echo "Building containers..."
          docker-compose build --no-cache
          echo "Starting containers..."
          docker-compose up -d
          echo "Cleaning up Docker system..."
          docker system prune -f
          echo "Deployment completed successfully!"
