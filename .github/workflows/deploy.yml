name: Deploy to VPS (No Docker)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Deploy to VPS
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USERNAME }}
        key: ${{ secrets.VPS_SSH_KEY }}
        passphrase: ${{ secrets.VPS_SSH_PASSPHRASE }}
        script: |
          echo "🚀 Starting application deployment..."
          
          # Set environment variables
          export MONGODB_URI="${{ secrets.MONGODB_URI }}"
          export JWT_SECRET="${{ secrets.JWT_SECRET }}"
          
          # Download deployment script
          echo "📥 Downloading deployment script..."
          wget -O deploy-app.sh https://raw.githubusercontent.com/ekow1/Kulobal-Health-Demo/main/deploy-app.sh
          chmod +x deploy-app.sh
          
          # Run deployment
          echo "🚀 Running deployment..."
          ./deploy-app.sh
          
          # Show final status
          echo "📊 Final application status:"
          pm2 status
          
          echo "📊 Final nginx status:"
          sudo systemctl status nginx --no-pager
          
          echo "✅ Deployment completed successfully!"
          echo "🌐 API is available at: https://server.ekowlabs.space"
